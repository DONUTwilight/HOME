<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>SAY SOMETHING</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5d7b93;
            --secondary-color: #8aa2b3;
            --light-color: #f8f5f2;
            --text-color: #333333;
            --border-color: #e0d6cc;
            --accent-color: #a87c5d;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 6px;
            --font-small: 13px;
            --font-normal: 15px;
            --font-large: 18px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Georgia", "Times New Roman", "宋体", serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-color);
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
            font-size: var(--font-normal);
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            padding-bottom: 80px; /* 为固定按钮留出空间 */
        }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        h1 {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: normal;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: var(--font-small);
            color: var(--secondary-color);
            margin-top: 8px;
        }

        .panel {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: var(--font-large);
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: var(--font-small);
            color: var(--secondary-color);
            font-weight: 500;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn {
            padding: 10px 18px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: var(--font-normal);
            transition: background 0.3s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--secondary-color);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: var(--font-small);
        }

        .btn-accent {
            background: var(--accent-color);
        }

        .btn-accent:hover {
            background: #8c6548;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: rgba(93, 123, 147, 0.1);
        }

        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: var(--font-normal);
            font-family: inherit;
            background: white;
            transition: border 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        /* 富文本编辑器工具栏 - 修改为固定定位 */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f9f7f5;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .toolbar-select {
            height: 36px;
            padding: 0 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        .toolbar-select:hover {
            border-color: var(--primary-color);
        }

        .toolbar-color {
            width: 36px;
            height: 36px;
            padding: 2px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }

        .toolbar-color:hover {
            border-color: var(--primary-color);
        }

        /* 标签系统 */
        .tag-system {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 10px;
            background: #f9f7f5;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: var(--font-small);
        }

        .tag .remove-tag {
            cursor: pointer;
            font-size: 12px;
            opacity: 0.8;
        }

        .tag .remove-tag:hover {
            opacity: 1;
        }

        .tag-history {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .history-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--light-color);
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-tag:hover {
            background: var(--primary-color);
            color: white;
        }

        .history-tag .remove-history-tag {
            cursor: pointer;
            font-size: 12px;
            opacity: 0.7;
            padding: 0 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-tag .remove-history-tag:hover {
            opacity: 1;
        }

        /* 文章列表 */
        .articles-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .article-item {
            padding: 18px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: white;
            transition: all 0.3s;
        }

        .article-item:hover {
            box-shadow: var(--shadow);
        }

        .article-title {
            font-size: var(--font-large);
            color: var(--primary-color);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .article-meta {
            display: flex;
            gap: 15px;
            font-size: var(--font-small);
            color: var(--secondary-color);
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .article-preview {
            font-size: var(--font-normal);
            line-height: 1.7;
            color: var(--text-color);
            margin-top: 12px;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .article-preview::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, white);
        }

        .article-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* 页面切换按钮 */
        .page-switcher {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 12px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .page-switcher-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            color: var(--secondary-color);
        }

        .page-switcher-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .page-switcher-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 响应式布局 */
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
            
            .input-section {
                flex: 1;
                display: block !important;
            }
            
            .articles-section {
                flex: 1;
                display: block !important;
            }
            
            .page-switcher {
                display: none; /* 电脑版不显示切换按钮 */
            }
        }

        @media (max-width: 767px) {
            .panel {
                padding: 20px 15px;
            }
            
            /* 手机版编辑器工具栏固定定位 */
            .editor-toolbar {
                position: sticky;
                top: 0;
                z-index: 10;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                overflow-x: auto;
                white-space: nowrap;
                justify-content: flex-start;
                scrollbar-width: none; /* Firefox */
            }
            
            .editor-toolbar::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Edge */
            }
            
            .article-title {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .input-with-button {
                flex-direction: column;
            }
            
            .article-actions {
                flex-direction: column;
            }
            
            .article-actions .btn {
                width: 100%;
            }
            
            /* 手机版隐藏非活动页面 */
            .input-section.mobile-hidden,
            .articles-section.mobile-hidden {
                display: none;
            }
            
            .page-switcher {
                top: 20px;
                right: 15px;
                flex-direction: row;
                padding: 8px;
                gap: 8px;
            }
            
            .page-switcher-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        /* 隐藏元素 */
        .hidden {
            display: none !important;
        }

        /* 状态提示 */
        .status-message {
            padding: 12px;
            border-radius: var(--radius);
            margin: 15px 0;
            font-size: var(--font-normal);
            text-align: center;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        /* 模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--secondary-color);
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: var(--primary-color);
        }

        /* 编辑器区域 */
        .textarea-editor {
            min-height: 300px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: white;
            overflow-y: auto;
            line-height: 1.7;
            outline: none;
            font-size: var(--font-normal);
        }

        .textarea-editor:focus {
            border-color: var(--primary-color);
        }

        .textarea-editor p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .textarea-editor ul, .textarea-editor ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        .textarea-editor blockquote {
            border-left: 3px solid var(--accent-color);
            padding-left: 15px;
            margin-left: 0;
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
            position: relative;
        }

        /* 修复代码块样式 - 不会超出页面 */
        .textarea-editor pre {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden !important;
        }

        .textarea-editor code {
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 14px;
        }

        .textarea-editor hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
            position: relative;
            z-index: 1;
        }

        /* 在水平线后添加一个特殊的占位符 */
        .textarea-editor hr::after {
            content: "";
            display: block;
            height: 0;
            overflow: hidden;
        }

        /* 字体大小类 - 修复版本 */
        .font-small {
            font-size: 14px !important;
            line-height: 1.6 !important;
        }
        .font-medium {
            font-size: 16px !important;
            line-height: 1.6 !important;
        }
        .font-large {
            font-size: 18px !important;
            line-height: 1.6 !important;
        }
        .font-xlarge {
            font-size: 20px !important;
            line-height: 1.6 !important;
        }

        /* 防止代码块溢出 */
        .textarea-editor * {
            max-width: 100%;
        }

        /* 响应式调整 */
        @media (max-width: 767px) {
            .textarea-editor pre {
                padding: 10px;
                font-size: 14px;
                margin: 10px 0;
            }
            
            .textarea-editor code {
                font-size: 13px;
            }
        }

        /* 固定保存按钮容器 */
        .btn-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 25px;
            position: sticky;
            bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            z-index: 5;
            transition: all 0.3s ease;
        }

        /* 响应式调整 */
        @media (max-width: 767px) {
            .btn-container {
                flex-direction: column;
                bottom: 10px;
                padding: 12px;
                gap: 10px;
            }
            
            .btn-container .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-book-open"></i> TALK TO ME</h1>
            <p class="subtitle">好想吃甜甜圈</p>
        </header>

        <!-- 页面切换按钮 (手机版显示) -->
        <div class="page-switcher">
            <button class="page-switcher-btn active" id="switch-to-input" title="文章录入">
                <i class="fas fa-edit"></i>
            </button>
            <button class="page-switcher-btn" id="switch-to-articles" title="已保存文章">
                <i class="fas fa-archive"></i>
            </button>
        </div>

        <main class="panel input-section" id="input-section">
            <h2 class="panel-title"><i class="fas fa-edit"></i> 文章录入</h2>
            
            <div class="form-group">
                <label for="article-title">文章标题（可选）</label>
                <input type="text" id="article-title" placeholder="无题？">
            </div>
            
            <div class="form-group">
                <label for="publish-date">发布时间（可选）</label>
                <div class="input-with-button">
                    <input type="datetime-local" id="publish-date">
                    <button type="button" id="current-time-btn" class="btn btn-small">
                        <i class="fas fa-clock"></i> 现在
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>文章内容</label>
                <div class="editor-toolbar" id="toolbar">
                    <button class="toolbar-btn" data-command="bold" title="加粗"><i class="fas fa-bold"></i></button>
                    <button class="toolbar-btn" data-command="italic" title="斜体"><i class="fas fa-italic"></i></button>
                    <button class="toolbar-btn" data-command="underline" title="下划线"><i class="fas fa-underline"></i></button>
                    <button class="toolbar-btn" data-command="insertUnorderedList" title="无序列表"><i class="fas fa-list-ul"></i></button>
                    <button class="toolbar-btn" data-command="insertOrderedList" title="有序列表"><i class="fas fa-list-ol"></i></button>
                    
                    <select class="toolbar-select" id="font-size-select" title="字体大小">
                        <option value="">字体大小</option>
                        <option value="font-small">小</option>
                        <option value="font-medium">中</option>
                        <option value="font-large">大</option>
                        <option value="font-xlarge">超大</option>
                    </select>
                    
                    <input type="color" class="toolbar-color" id="font-color" value="#333333" title="字体颜色">
                    <input type="color" class="toolbar-color" id="bg-color" value="#ffffff" title="背景颜色">
                    
                    <button class="toolbar-btn" data-command="justifyLeft" title="左对齐"><i class="fas fa-align-left"></i></button>
                    <button class="toolbar-btn" data-command="justifyCenter" title="居中对齐"><i class="fas fa-align-center"></i></button>
                    <button class="toolbar-btn" data-command="justifyRight" title="右对齐"><i class="fas fa-align-right"></i></button>
                    <button class="toolbar-btn" data-command="createLink" title="插入链接"><i class="fas fa-link"></i></button>
                    <button class="toolbar-btn" data-command="unlink" title="取消链接"><i class="fas fa-unlink"></i></button>
                    <button class="toolbar-btn" data-command="formatBlock" data-value="blockquote" title="引用"><i class="fas fa-quote-right"></i></button>
                    <button class="toolbar-btn" id="insert-code" title="插入代码块"><i class="fas fa-code"></i></button>
                    <button class="toolbar-btn" id="insert-hr" title="插入水平线"><i class="fas fa-minus"></i></button>
                </div>
                <div id="editor" contenteditable="true" class="textarea-editor"></div>
            </div>
            
            <div class="form-group">
                <label>标签系统</label>
                <div class="tag-system">
                    <div class="tag-input-container">
                        <input type="text" id="tag-input" placeholder="输入标签，按回车或逗号添加">
                        <button type="button" id="add-tag-btn" class="btn btn-small">
                            <i class="fas fa-plus"></i> 添加
                        </button>
                    </div>
                    <div class="tag-list" id="tag-container">
                        <!-- 标签将在这里动态生成 -->
                    </div>
                    <div>
                        <div style="font-size: var(--font-small); color: var(--secondary-color); margin-bottom: 8px;">历史标签：</div>
                        <div class="tag-history" id="tag-history">
                            <!-- 历史标签将在这里动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="status-message" class="status-message hidden"></div>
            
            <div class="btn-container">
                <button type="button" id="save-article-btn" class="btn">
                    <i class="fas fa-save"></i> 保存文章
                </button>
                <button type="button" id="export-html-btn" class="btn btn-accent">
                    <i class="fas fa-file-export"></i> 导出HTML
                </button>
                <button type="button" id="export-md-btn" class="btn btn-outline">
                    <i class="fas fa-file-alt"></i> 导出Markdown
                </button>
                <button type="button" id="clear-btn" class="btn btn-outline">
                    <i class="fas fa-trash-alt"></i> 清空
                </button>
            </div>
        </main>
        
        <section class="panel articles-section mobile-hidden" id="articles-section">
            <h2 class="panel-title"><i class="fas fa-archive"></i> 已保存的文章</h2>
            
            <div class="articles-list" id="articles-list">
                <!-- 文章列表将在这里动态生成 -->
            </div>
            
            <div id="empty-message" style="text-align: center; padding: 40px 20px; color: var(--secondary-color);">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px;"></i>
                <p>尚未保存任何文章</p>
                <p style="font-size: var(--font-small); margin-top: 10px;">开始撰写您的第一篇文章吧</p>
            </div>
        </section>
    </div>

    <!-- 导出预览模态框 -->
    <div id="export-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: var(--primary-color); margin: 0;">导出预览</h3>
                <button class="close-modal" id="close-export-modal">&times;</button>
            </div>
            <div class="modal-body" id="export-preview-content">
                <!-- 导出内容将在这里动态生成 -->
            </div>
            <div class="modal-footer">
                <button id="copy-export-btn" class="btn btn-small">
                    <i class="fas fa-copy"></i> 复制内容
                </button>
                <button id="download-export-btn" class="btn btn-accent btn-small">
                    <i class="fas fa-download"></i> 下载文件
                </button>
            </div>
        </div>
    </div>

    <script>
        // 页面切换功能
        class PageSwitcher {
            constructor() {
                this.isMobile = window.innerWidth < 768;
                this.currentPage = 'input'; // 'input' 或 'articles'
                this.init();
            }
            
            init() {
                if (this.isMobile) {
                    this.setupMobileSwitcher();
                }
            }
            
            setupMobileSwitcher() {
                const inputSection = document.getElementById('input-section');
                const articlesSection = document.getElementById('articles-section');
                const switchToInputBtn = document.getElementById('switch-to-input');
                const switchToArticlesBtn = document.getElementById('switch-to-articles');
                
                // 初始状态：显示输入页面，隐藏文章页面
                inputSection.classList.remove('mobile-hidden');
                articlesSection.classList.add('mobile-hidden');
                
                // 切换到输入页面
                switchToInputBtn.addEventListener('click', () => {
                    if (this.currentPage !== 'input') {
                        this.switchToPage('input');
                    }
                });
                
                // 切换到文章页面
                switchToArticlesBtn.addEventListener('click', () => {
                    if (this.currentPage !== 'articles') {
                        this.switchToPage('articles');
                    }
                });
                
                // 监听窗口大小变化
                window.addEventListener('resize', () => {
                    this.handleResize();
                });
            }
            
            switchToPage(page) {
                const inputSection = document.getElementById('input-section');
                const articlesSection = document.getElementById('articles-section');
                const switchToInputBtn = document.getElementById('switch-to-input');
                const switchToArticlesBtn = document.getElementById('switch-to-articles');
                
                if (page === 'input') {
                    inputSection.classList.remove('mobile-hidden');
                    articlesSection.classList.add('mobile-hidden');
                    switchToInputBtn.classList.add('active');
                    switchToArticlesBtn.classList.remove('active');
                    this.currentPage = 'input';
                } else if (page === 'articles') {
                    articlesSection.classList.remove('mobile-hidden');
                    inputSection.classList.add('mobile-hidden');
                    switchToArticlesBtn.classList.add('active');
                    switchToInputBtn.classList.remove('active');
                    this.currentPage = 'articles';
                }
            }
            
            handleResize() {
                const newIsMobile = window.innerWidth < 768;
                
                if (newIsMobile !== this.isMobile) {
                    this.isMobile = newIsMobile;
                    const inputSection = document.getElementById('input-section');
                    const articlesSection = document.getElementById('articles-section');
                    const pageSwitcher = document.querySelector('.page-switcher');
                    
                    if (this.isMobile) {
                        // 切换到手机模式
                        pageSwitcher.style.display = 'flex';
                        // 确保只显示当前页面
                        if (this.currentPage === 'input') {
                            inputSection.classList.remove('mobile-hidden');
                            articlesSection.classList.add('mobile-hidden');
                        } else {
                            articlesSection.classList.remove('mobile-hidden');
                            inputSection.classList.add('mobile-hidden');
                        }
                    } else {
                        // 切换到电脑模式 - 显示两个页面，隐藏切换按钮
                        pageSwitcher.style.display = 'none';
                        inputSection.classList.remove('mobile-hidden');
                        articlesSection.classList.remove('mobile-hidden');
                    }
                }
            }
        }
        
        // 文章管理类
        class ArticleManager {
            constructor() {
                this.articles = JSON.parse(localStorage.getItem('articles') || '[]');
                this.tagsHistory = JSON.parse(localStorage.getItem('tagsHistory') || '[]');
                this.currentExportContent = null;
                this.currentExportFileName = null;
                this.currentExportType = null;
                this.enterPressTime = 0;
                this.enterPressCount = 0;
                this.init();
            }
            
            init() {
                this.renderArticles();
                this.renderTagsHistory();
                this.setupEventListeners();
                
                // 设置编辑器默认提示
                const editor = document.getElementById('editor');
                if (!editor.innerHTML.trim()) {
                    editor.innerHTML = '<p>说点什么吧，不然好寂寞</p>';
                }
            }
            
            // 保存文章
            saveArticle() {
                const title = document.getElementById('article-title').value.trim();
                const date = document.getElementById('publish-date').value;
                const content = document.getElementById('editor').innerHTML;
                const tags = Array.from(document.querySelectorAll('.tag span:first-child')).map(tag => tag.textContent);
                
                if (!content || content === '<p>说点什么吧，不然好寂寞</p>' || content === '<br>') {
                    this.showMessage('请填写文章内容', 'error');
                    return;
                }
                
                const article = {
                    id: Date.now(),
                    title: title || '无题',
                    date: date || null,
                    content: content,
                    tags: tags.length > 0 ? tags : ['未分类'],
                    created: new Date().toISOString()
                };
                
                this.articles.unshift(article);
                this.saveToLocalStorage();
                
                // 更新标签历史
                tags.forEach(tag => {
                    if (tag !== '未分类' && !this.tagsHistory.includes(tag)) {
                        this.tagsHistory.push(tag);
                    }
                });
                localStorage.setItem('tagsHistory', JSON.stringify(this.tagsHistory));
                
                this.renderArticles();
                this.renderTagsHistory();
                this.clearForm();
                this.showMessage('文章已保存', 'success');
                
                // 保存后自动切换到文章列表页面（手机版）
                if (window.innerWidth < 768) {
                    const pageSwitcher = new PageSwitcher();
                    pageSwitcher.switchToPage('articles');
                }
            }
            
            // 保存到本地存储
            saveToLocalStorage() {
                localStorage.setItem('articles', JSON.stringify(this.articles));
            }
            
            // 渲染文章列表
            renderArticles() {
                const articlesList = document.getElementById('articles-list');
                const emptyMessage = document.getElementById('empty-message');
                
                if (this.articles.length === 0) {
                    articlesList.innerHTML = '';
                    emptyMessage.classList.remove('hidden');
                    return;
                }
                
                emptyMessage.classList.add('hidden');
                
                let articlesHTML = '';
                this.articles.forEach(article => {
                    // 修改：格式化日期显示，只显示年月日时间
                    const dateStr = this.formatDateTime(article.date);
                    const createdStr = this.formatDateTime(article.created);
                    
                    const previewContent = this.stripHTML(article.content).substring(0, 200);
                    const tagsHTML = article.tags.map(tag => 
                        `<span style="background: #f0f0f0; padding: 2px 8px; border-radius: 12px; margin-left: 5px; font-size: 12px;">${tag}</span>`
                    ).join('');
                    
                    articlesHTML += `
                        <div class="article-item" data-id="${article.id}">
                            <div class="article-title">
                                <span>${article.title}</span>
                                <div style="margin-top: 5px;">
                                    ${tagsHTML}
                                </div>
                            </div>
                            <div class="article-meta">
                                <span><i class="far fa-calendar"></i> ${dateStr}</span>
                                <span><i class="far fa-clock"></i> ${createdStr}</span>
                            </div>
                            <div class="article-preview">${previewContent}...</div>
                            <div class="article-actions">
                                <button class="btn btn-small btn-outline edit-article" data-id="${article.id}">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-small btn-outline export-single-html" data-id="${article.id}">
                                    <i class="fas fa-file-export"></i> 导出HTML
                                </button>
                                <button class="btn btn-small btn-outline export-single-md" data-id="${article.id}">
                                    <i class="fas fa-file-alt"></i> 导出MD
                                </button>
                                <button class="btn btn-small btn-outline delete-article" data-id="${article.id}">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                articlesList.innerHTML = articlesHTML;
                
                // 为文章操作按钮添加事件监听
                this.attachArticleEventListeners();
            }
            
            // 格式化日期时间
            formatDateTime(dateTimeString) {
                if (!dateTimeString) return '----年--月--日 --:--';
                
                try {
                    // 检查是否是ISO格式
                    let date;
                    if (dateTimeString.includes('T') && dateTimeString.includes(':')) {
                        // ISO格式
                        date = new Date(dateTimeString);
                    } else {
                        // 可能是本地日期时间格式
                        date = new Date(dateTimeString + 'Z');
                    }
                    
                    // 检查日期是否有效
                    if (isNaN(date.getTime())) {
                        // 尝试其他格式
                        date = new Date(dateTimeString);
                        if (isNaN(date.getTime())) {
                            return '----年--月--日 --:--';
                        }
                    }
                    
                    // 提取日期部分
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    
                    return `${year}年${month}月${day}日 ${hours}:${minutes}`;
                } catch (e) {
                    return '----年--月--日 --:--';
                }
            }
            
            // 格式化日期用于文件名（确保与显示格式一致）
            formatDateForFileName(dateTimeString) {
                if (!dateTimeString) return '----年--月--日';
                
                try {
                    // 检查是否是ISO格式
                    let date;
                    if (dateTimeString.includes('T') && dateTimeString.includes(':')) {
                        // ISO格式
                        date = new Date(dateTimeString);
                    } else {
                        // 可能是本地日期时间格式
                        date = new Date(dateTimeString + 'Z');
                    }
                    
                    if (isNaN(date.getTime())) {
                        // 尝试其他格式
                        date = new Date(dateTimeString);
                        if (isNaN(date.getTime())) {
                            return '----年--月--日';
                        }
                    }
                    
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    
                    return `${year}年${month}月${day}日`;
                } catch (e) {
                    return '----年--月--日';
                }
            }
            
            // 为文章操作按钮添加事件监听
            attachArticleEventListeners() {
                document.querySelectorAll('.edit-article').forEach(btn => {
                    btn.addEventListener('click', (e) => this.editArticle(e.target.dataset.id));
                });
                
                document.querySelectorAll('.export-single-html').forEach(btn => {
                    btn.addEventListener('click', (e) => this.exportSingleArticle(e.target.dataset.id, 'html'));
                });
                
                document.querySelectorAll('.export-single-md').forEach(btn => {
                    btn.addEventListener('click', (e) => this.exportSingleArticle(e.target.dataset.id, 'markdown'));
                });
                
                document.querySelectorAll('.delete-article').forEach(btn => {
                    btn.addEventListener('click', (e) => this.deleteArticle(e.target.dataset.id));
                });
            }
            
            // 编辑文章
            editArticle(id) {
                const article = this.articles.find(a => a.id == id);
                if (!article) return;
                
                document.getElementById('article-title').value = article.title === '无题' ? '' : article.title;
                document.getElementById('publish-date').value = article.date || '';
                document.getElementById('editor').innerHTML = article.content;
                
                // 清空当前标签并添加文章标签
                const tagContainer = document.getElementById('tag-container');
                tagContainer.innerHTML = '';
                article.tags.forEach(tag => {
                    if (tag !== '未分类') {
                        this.addTagToContainer(tag);
                    }
                });
                
                this.showMessage('文章已加载到编辑器中', 'success');
                
                // 滚动到顶部并切换到输入页面（如果是手机版）
                document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
                
                if (window.innerWidth < 768) {
                    const pageSwitcher = new PageSwitcher();
                    pageSwitcher.switchToPage('input');
                }
            }
            
            // 删除文章
            deleteArticle(id) {
                if (confirm('确定要删除这篇文章吗？此操作不可撤销。')) {
                    this.articles = this.articles.filter(a => a.id != id);
                    this.saveToLocalStorage();
                    this.renderArticles();
                    this.showMessage('文章已删除', 'success');
                }
            }
            
            // 导出单篇文章
            exportSingleArticle(id, format) {
                const article = this.articles.find(a => a.id == id);
                if (!article) return;
                
                if (format === 'html') {
                    this.generateHTMLExport(article);
                } else {
                    this.generateMarkdownExport(article);
                }
            }
            
            // 导出所有文章
            exportAllArticles(format) {
                if (this.articles.length === 0) {
                    this.showMessage('没有文章可以导出', 'error');
                    return;
                }
                
                if (format === 'html') {
                    this.exportAllAsHTML();
                } else {
                    this.exportAllAsMarkdown();
                }
            }
            
            // 生成HTML导出
            generateHTMLExport(article) {
                const dateStr = this.formatDateTime(article.date);
                const tagStr = article.tags.length > 0 ? article.tags.join(', ') : '无标签';
                const primaryTag = article.tags.length > 0 ? article.tags[0] : '无标签';
                
                const htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${article.title}</title>
    <style>
        body {
            font-family: "Georgia", "Times New Roman", serif;
            line-height: 1.7;
            color: #333;
            background: #fefefe;
            padding: 25px;
            max-width: 800px;
            margin: 0 auto;
            font-size: 16px;
        }
        .export-header {
            border-bottom: 1px solid #e0d6cc;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .export-title {
            font-size: 28px;
            color: #5d7b93;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        .export-meta {
            font-size: 14px;
            color: #8aa2b3;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .export-content {
            font-size: 16px;
            line-height: 1.8;
        }
        .export-content p {
            margin-bottom: 20px;
            text-align: justify;
        }
        .export-content h2 {
            font-size: 22px;
            color: #5d7b93;
            margin: 30px 0 15px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e0d6cc;
        }
        .export-content blockquote {
            border-left: 3px solid #e0d6cc;
            padding-left: 20px;
            margin: 25px 0;
            color: #666;
            font-style: italic;
        }
        .export-content pre {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            font-size: 14px;
        }
        .export-content ul, .export-content ol {
            margin: 20px 0;
            padding-left: 30px;
        }
        .export-content li {
            margin-bottom: 8px;
        }
        .export-content a {
            color: #5d7b93;
            text-decoration: none;
            border-bottom: 1px dotted #5d7b93;
        }
        .export-content a:hover {
            border-bottom: 1px solid #5d7b93;
        }
        .export-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0d6cc;
            font-size: 14px;
            color: #8aa2b3;
            text-align: center;
        }
        @media (max-width: 768px) {
            body {
                padding: 20px 15px;
            }
            .export-title {
                font-size: 24px;
            }
            .export-content pre {
                padding: 10px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="export-header">
        <h1 class="export-title">${article.title}</h1>
        <div class="export-meta">
            <span><i class="far fa-calendar"></i> ${dateStr}</span>
            <span><i class="fas fa-tags"></i> ${tagStr}</span>
        </div>
    </div>
    
    <div class="export-content">
        ${article.content}
    </div>
    
    <div class="export-footer">
        <p>by DONUTwilight · ${new Date().toLocaleDateString('zh-CN')}</p>
    </div>
</body>
</html>`;
                
                // 生成文件名（使用相同的日期格式）
                const fileName = this.generateFileName(article, 'html');
                
                // 显示预览
                this.showExportPreview(htmlContent, fileName, 'html');
            }
            
            // 生成Markdown导出
            generateMarkdownExport(article) {
                const dateStr = this.formatDateTime(article.date);
                const tagStr = article.tags.length > 0 ? article.tags.map(t => `#${t}`).join(' ') : '#无标签';
                
                // 转换HTML为Markdown（简化版本）
                let mdContent = this.convertHTMLToMarkdown(article.content);
                
                // 添加元数据
                const fullMdContent = `# ${article.title}\n\n**发布时间:** ${dateStr}\n\n**标签:** ${tagStr}\n\n---\n\n${mdContent}\n\n---\n\n*by DONUTwilight · ${new Date().toLocaleDateString('zh-CN')}*`;
                
                // 生成文件名（使用相同的日期格式）
                const fileName = this.generateFileName(article, 'md');
                
                // 显示预览
                this.showExportPreview(fullMdContent, fileName, 'markdown');
            }
            
            // 转换HTML为Markdown
            convertHTMLToMarkdown(html) {
                let md = html;
                
                // 替换标题
                md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
                md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
                md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
                md = md.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n');
                
                // 替换粗体和斜体
                md = md.replace(/<strong>(.*?)<\/strong>/gi, '**$1**');
                md = md.replace(/<b>(.*?)<\/b>/gi, '**$1**');
                md = md.replace(/<em>(.*?)<\/em>/gi, '*$1*');
                md = md.replace(/<i>(.*?)<\/i>/gi, '*$1*');
                
                // 替换链接
                md = md.replace(/<a\s+href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
                
                // 替换引用
                md = md.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gis, (match, content) => {
                    // 清理内容中的HTML标签
                    const cleanContent = content.replace(/<[^>]+>/g, '');
                    return '> ' + cleanContent.trim().replace(/\n/g, '\n> ') + '\n\n';
                });
                
                // 替换代码块
                md = md.replace(/<pre[^>]*>(.*?)<\/pre>/gis, (match, content) => {
                    // 移除可能的code标签
                    const cleanContent = content.replace(/<code[^>]*>(.*?)<\/code>/gi, '$1');
                    return '```\n' + cleanContent.trim() + '\n```\n\n';
                });
                
                // 替换列表
                md = md.replace(/<ul[^>]*>(.*?)<\/ul>/gis, (match, content) => {
                    return content.replace(/<li>(.*?)<\/li>/gi, '- $1\n') + '\n';
                });
                
                md = md.replace(/<ol[^>]*>(.*?)<\/ol>/gis, (match, content) => {
                    let counter = 1;
                    return content.replace(/<li>(.*?)<\/li>/gi, () => {
                        return `${counter++}. $1\n`;
                    }) + '\n';
                });
                
                // 替换段落和换行
                md = md.replace(/<p>(.*?)<\/p>/gi, '$1\n\n');
                md = md.replace(/<br\s*\/?>/gi, '\n');
                md = md.replace(/<div>(.*?)<\/div>/gi, '$1\n\n');
                
                // 移除所有剩余的HTML标签
                md = md.replace(/<[^>]+>/g, '');
                
                // 清理多余的空行
                md = md.replace(/\n\s*\n\s*\n/g, '\n\n');
                
                return md.trim();
            }
            
            // 导出所有文章为HTML合集
            exportAllAsHTML() {
                const dateStr = this.formatDateTime(new Date().toISOString());
                
                let articlesHTML = '';
                this.articles.forEach((article, index) => {
                    const articleDate = this.formatDateTime(article.date);
                    const articleTags = article.tags.length > 0 ? article.tags.join(', ') : '无标签';
                    
                    articlesHTML += `
                        <article class="blog-article" id="article-${index}">
                            <h2 class="article-title">${article.title}</h2>
                            <div class="article-meta">
                                <span><i class="far fa-calendar"></i> ${articleDate}</span>
                                <span><i class="fas fa-tags"></i> ${articleTags}</span>
                            </div>
                            <div class="article-content">
                                ${article.content}
                            </div>
                            <hr class="article-divider">
                        </article>
                    `;
                });
                
                const fullHTML = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章合集</title>
    <style>
        body {
            font-family: "Georgia", "Times New Roman", serif;
            line-height: 1.7;
            color: #333;
            background: #fefefe;
            padding: 25px;
            max-width: 800px;
            margin: 0 auto;
            font-size: 16px;
        }
        .collection-header {
            border-bottom: 1px solid #e0d6cc;
            padding-bottom: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .collection-title {
            font-size: 32px;
            color: #5d7b93;
            margin-bottom: 10px;
        }
        .collection-subtitle {
            font-size: 16px;
            color: #8aa2b3;
        }
        .collection-info {
            font-size: 14px;
            color: #8aa2b3;
            margin-top: 15px;
        }
        .blog-article {
            margin-bottom: 40px;
        }
        .article-title {
            font-size: 24px;
            color: #5d7b93;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        .article-meta {
            font-size: 14px;
            color: #8aa2b3;
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .article-content {
            font-size: 16px;
            line-height: 1.8;
        }
        .article-content p {
            margin-bottom: 20px;
            text-align: justify;
        }
        .article-content h2 {
            font-size: 20px;
            color: #5d7b93;
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e0d6cc;
        }
        .article-content blockquote {
            border-left: 4px solid #e0d6cc;
            padding-left: 20px;
            margin: 25px 0;
            color: #666;
            font-style: italic;
        }
        .article-content pre {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            font-size: 14px;
        }
        .article-divider {
            border: none;
            border-top: 1px solid #e0d6cc;
            margin: 40px 0;
        }
        .collection-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0d6cc;
            font-size: 14px;
            color: #8aa2b3;
            text-align: center;
        }
        @media (max-width: 768px) {
            body {
                padding: 20px 15px;
            }
            .collection-title {
                font-size: 28px;
            }
            .article-title {
                font-size: 22px;
            }
            .article-content pre {
                padding: 10px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <header class="collection-header">
        <h1 class="collection-title">文章合集</h1>
        <p class="collection-subtitle">思想的片段，时间的印记</p>
        <div class="collection-info">
            <p>共收录 ${this.articles.length} 篇文章 · 生成于 ${dateStr}</p>
        </div>
    </header>
    
    ${articlesHTML}
    
    <footer class="collection-footer">
        <p>由「文艺文章整理器」生成 · 简约文艺 · 静心书写</p>
    </footer>
</body>
</html>`;
                
                // 生成文件名
                const fileName = `文章合集-${dateStr.replace(/[/:\\]/g, '-')}.html`;
                
                // 显示预览
                this.showExportPreview(fullHTML, fileName, 'html');
            }
            
            // 导出所有文章为Markdown合集
            exportAllAsMarkdown() {
                const dateStr = this.formatDateTime(new Date().toISOString());
                
                let mdContent = `# 文章合集\n\n**生成时间:** ${dateStr}\n\n**文章数量:** ${this.articles.length}\n\n---\n\n`;
                
                this.articles.forEach((article, index) => {
                    const articleDate = this.formatDateTime(article.date);
                    const articleTags = article.tags.length > 0 ? article.tags.map(t => `#${t}`).join(' ') : '#无标签';
                    
                    // 转换HTML为Markdown
                    let articleMd = this.convertHTMLToMarkdown(article.content);
                    
                    mdContent += `## ${article.title}\n\n**发布时间:** ${articleDate}\n\n**标签:** ${articleTags}\n\n${articleMd}\n\n---\n\n`;
                });
                
                mdContent += `\n*由「文艺文章整理器」生成 · ${dateStr}*`;
                
                // 生成文件名
                const fileName = `文章合集-${dateStr.replace(/[/:\\]/g, '-')}.md`;
                
                // 显示预览
                this.showExportPreview(mdContent, fileName, 'markdown');
            }
            
            // 生成文件名（确保日期格式一致）
            generateFileName(article, extension) {
                const primaryTag = article.tags.length > 0 ? article.tags[0] : '无标签';
                const datePart = this.formatDateForFileName(article.date);
                const titlePart = article.title === '无题' ? '无题' : article.title.substring(0, 30).replace(/[^\w\u4e00-\u9fa5]/g, '-');
                
                return `${primaryTag}-${datePart}-${titlePart}.${extension}`;
            }
            
            // 显示导出预览
            showExportPreview(content, fileName, format) {
                this.currentExportContent = content;
                this.currentExportFileName = fileName;
                this.currentExportType = format;
                
                const modal = document.getElementById('export-modal');
                const previewContent = document.getElementById('export-preview-content');
                
                // 设置预览内容
                if (format === 'html') {
                    previewContent.innerHTML = `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: var(--radius);">
                            <p style="margin-bottom: 5px;"><strong>文件名:</strong> ${fileName}</p>
                            <p style="margin-bottom: 5px;"><strong>格式:</strong> HTML</p>
                            <p style="margin-bottom: 0;"><strong>文件大小:</strong> ${this.formatFileSize(content.length)}</p>
                        </div>
                        <div style="height: 400px; overflow: auto; border: 1px solid #ddd; padding: 15px; background: white; border-radius: var(--radius);">
                            <pre style="white-space: pre-wrap; font-size: 13px; line-height: 1.5; margin: 0; font-family: 'Courier New', monospace;">${this.escapeHTML(content)}</pre>
                        </div>
                    `;
                } else {
                    previewContent.innerHTML = `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: var(--radius);">
                            <p style="margin-bottom: 5px;"><strong>文件名:</strong> ${fileName}</p>
                            <p style="margin-bottom: 5px;"><strong>格式:</strong> Markdown</p>
                            <p style="margin-bottom: 0;"><strong>文件大小:</strong> ${this.formatFileSize(content.length)}</p>
                        </div>
                        <div style="height: 400px; overflow: auto; border: 1px solid #ddd; padding: 15px; background: white; border-radius: var(--radius);">
                            <pre style="white-space: pre-wrap; font-size: 14px; line-height: 1.6; margin: 0; font-family: 'Courier New', monospace;">${content}</pre>
                        </div>
                    `;
                }
                
                modal.classList.remove('hidden');
            }
            
            // 格式化文件大小
            formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
                else return (bytes / 1048576).toFixed(2) + ' MB';
            }
            
            // 渲染标签历史（带删除按钮）
            renderTagsHistory() {
                const tagHistoryContainer = document.getElementById('tag-history');
                
                if (this.tagsHistory.length === 0) {
                    tagHistoryContainer.innerHTML = '<span style="color: var(--secondary-color); font-size: var(--font-small);">暂无标签历史</span>';
                    return;
                }
                
                let tagsHTML = '';
                this.tagsHistory.forEach(tag => {
                    tagsHTML += `
                        <span class="history-tag" data-tag="${tag}">
                            ${tag}
                            <span class="remove-history-tag" data-tag="${tag}">
                                <i class="fas fa-times"></i>
                            </span>
                        </span>
                    `;
                });
                
                tagHistoryContainer.innerHTML = tagsHTML;
                
                // 为历史标签添加点击事件
                document.querySelectorAll('.history-tag').forEach(tagEl => {
                    // 点击标签本身添加到当前标签
                    tagEl.addEventListener('click', (e) => {
                        // 如果点击的是删除按钮，不执行添加操作
                        if (e.target.closest('.remove-history-tag')) return;
                        this.addTagToContainer(e.currentTarget.dataset.tag);
                    });
                    
                    // 点击删除按钮从历史中移除标签
                    const removeBtn = tagEl.querySelector('.remove-history-tag');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const tagToRemove = e.target.closest('.remove-history-tag').dataset.tag;
                            this.removeTagFromHistory(tagToRemove);
                        });
                    }
                });
            }
            
            // 从历史标签中移除标签
            removeTagFromHistory(tag) {
                if (confirm(`确定要从历史标签中移除"${tag}"吗？`)) {
                    this.tagsHistory = this.tagsHistory.filter(t => t !== tag);
                    localStorage.setItem('tagsHistory', JSON.stringify(this.tagsHistory));
                    this.renderTagsHistory();
                    this.showMessage(`标签"${tag}"已从历史中移除`, 'success');
                }
            }
            
            // 添加标签到容器
            addTagToContainer(tagText) {
                tagText = tagText.trim();
                if (!tagText) return;
                
                // 检查是否已存在相同标签
                const existingTags = Array.from(document.querySelectorAll('.tag span:first-child')).map(tag => tag.textContent);
                if (existingTags.includes(tagText)) {
                    this.showMessage('标签已存在', 'error');
                    return;
                }
                
                const tagContainer = document.getElementById('tag-container');
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    <span>${tagText}</span>
                    <span class="remove-tag"><i class="fas fa-times"></i></span>
                `;
                
                tagContainer.appendChild(tagElement);
                
                // 添加删除事件
                tagElement.querySelector('.remove-tag').addEventListener('click', () => {
                    tagElement.remove();
                });
                
                // 清空输入框
                document.getElementById('tag-input').value = '';
            }
            
            // 清除表单
            clearForm() {
                document.getElementById('article-title').value = '';
                document.getElementById('publish-date').value = '';
                document.getElementById('editor').innerHTML = '<p>说点什么吧，不然好寂寞</p>';
                document.getElementById('tag-container').innerHTML = '';
                this.showMessage('', '');
            }
            
            // 显示消息
            showMessage(message, type) {
                const statusElement = document.getElementById('status-message');
                
                if (!message) {
                    statusElement.classList.add('hidden');
                    return;
                }
                
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
                statusElement.classList.remove('hidden');
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 3000);
            }
            
            // 去除HTML标签
            stripHTML(html) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            }
            
            // 转义HTML
            escapeHTML(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // ==================== 新增功能方法 ====================
            
            // 检查是否在blockquote末尾
            isAtEndOfBlockquote(range, blockquote) {
                // 检查光标是否在blockquote的末尾
                const blockquoteRange = document.createRange();
                blockquoteRange.selectNodeContents(blockquote);
                blockquoteRange.collapse(false); // 到末尾
                
                const container = range.endContainer;
                const offset = range.endOffset;
                const endContainer = blockquoteRange.endContainer;
                const endOffset = blockquoteRange.endOffset;
                
                // 检查是否在同一个节点并且位置相同或接近
                if (container === endContainer && Math.abs(offset - endOffset) <= 1) {
                    return true;
                }
                
                // 检查是否在blockquote的最后一个元素内并且光标在末尾
                const lastChild = blockquote.lastElementChild;
                if (lastChild && lastChild.contains(container)) {
                    const childRange = document.createRange();
                    childRange.selectNodeContents(lastChild);
                    childRange.collapse(false);
                    
                    if (container === childRange.endContainer && 
                        Math.abs(offset - childRange.endOffset) <= 1) {
                        return true;
                    }
                }
                
                return false;
            }
            
            // 退出blockquote
            exitBlockquote(blockquote, range, selection) {
                // 创建一个新的段落在blockquote之后
                const newParagraph = document.createElement('p');
                newParagraph.innerHTML = '<br>';
                
                // 插入新段落
                blockquote.parentNode.insertBefore(newParagraph, blockquote.nextSibling);
                
                // 将光标移动到新段落
                const newRange = document.createRange();
                newRange.setStart(newParagraph, 0);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
            
            // 处理blockquote内的回车
            handleQuoteEnter(e) {
                const editor = document.getElementById('editor');
                const selection = window.getSelection();
                
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const blockquote = range.commonAncestorContainer.closest('blockquote');
                    
                    if (blockquote) {
                        // 检查是否在blockquote的最后一个子元素内
                        const lastChild = blockquote.lastElementChild;
                        const isInLastChild = lastChild && lastChild.contains(range.commonAncestorContainer);
                        
                        if (isInLastChild) {
                            // 检查光标是否在最后一个子元素的末尾
                            const childRange = document.createRange();
                            childRange.selectNodeContents(lastChild);
                            childRange.collapse(false); // 到末尾
                            
                            const container = range.endContainer;
                            const offset = range.endOffset;
                            const endContainer = childRange.endContainer;
                            const endOffset = childRange.endOffset;
                            
                            // 判断是否在末尾
                            if (container === endContainer && offset === endOffset) {
                                const now = Date.now();
                                
                                // 检查是否是第二次快速回车
                                if (now - this.enterPressTime < 500) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    
                                    // 创建新的段落放在blockquote之后
                                    const newParagraph = document.createElement('p');
                                    newParagraph.innerHTML = '<br>';
                                    
                                    // 插入到blockquote之后
                                    blockquote.parentNode.insertBefore(newParagraph, blockquote.nextSibling);
                                    
                                    // 将光标移动到新段落
                                    const newRange = document.createRange();
                                    newRange.setStart(newParagraph, 0);
                                    newRange.collapse(true);
                                    selection.removeAllRanges();
                                    selection.addRange(newRange);
                                    
                                    // 重置计数器
                                    this.enterPressTime = 0;
                                    this.enterPressCount = 0;
                                } else {
                                    // 第一次回车，记录时间
                                    this.enterPressTime = now;
                                    this.enterPressCount = 1;
                                    // 允许默认的回车行为（在blockquote内创建新段落）
                                }
                            } else {
                                // 不在末尾，允许正常的回车行为
                                this.enterPressTime = 0;
                                this.enterPressCount = 0;
                            }
                        } else {
                            // 不在最后一个子元素内，允许正常的回车行为
                            this.enterPressTime = 0;
                            this.enterPressCount = 0;
                        }
                    } else {
                        // 不在blockquote内，重置计数器
                        this.enterPressTime = 0;
                        this.enterPressCount = 0;
                    }
                }
            }
            
            // ==================== 事件监听器设置 ====================
            
            // 设置事件监听器
            setupEventListeners() {
                // 保存文章按钮
                document.getElementById('save-article-btn').addEventListener('click', () => {
                    this.saveArticle();
                });
                
                // 导出HTML按钮
                document.getElementById('export-html-btn').addEventListener('click', () => {
                    this.exportAllArticles('html');
                });
                
                // 导出Markdown按钮
                document.getElementById('export-md-btn').addEventListener('click', () => {
                    this.exportAllArticles('markdown');
                });
                
                // 清空按钮
                document.getElementById('clear-btn').addEventListener('click', () => {
                    if (confirm('确定要清空当前编辑的内容吗？')) {
                        this.clearForm();
                    }
                });
                
                // 当前时间按钮
                document.getElementById('current-time-btn').addEventListener('click', () => {
                    const now = new Date();
                    // 转换为本地时间字符串，格式为YYYY-MM-DDTHH:MM
                    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                    document.getElementById('publish-date').value = localDateTime;
                });
                
                // 标签输入
                document.getElementById('tag-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        this.addTagToContainer(document.getElementById('tag-input').value);
                    }
                });
                
                // 添加标签按钮
                document.getElementById('add-tag-btn').addEventListener('click', () => {
                    this.addTagToContainer(document.getElementById('tag-input').value);
                });
                
                // ==================== 富文本编辑器工具栏 ====================
                
                // 基本的富文本命令
                document.querySelectorAll('.toolbar-btn[data-command]').forEach(button => {
                    button.addEventListener('click', () => {
                        const command = button.dataset.command;
                        const value = button.dataset.value;
                        
                        document.getElementById('editor').focus();
                        
                        if (command === 'createLink') {
                            const url = prompt('请输入链接地址:', 'https://');
                            if (url) {
                                document.execCommand(command, false, url);
                            }
                        } else if (command === 'formatBlock' && value === 'blockquote') {
                            // 检查是否已经在blockquote内
                            const selection = window.getSelection();
                            if (selection.rangeCount > 0) {
                                const range = selection.getRangeAt(0);
                                const blockquote = range.commonAncestorContainer.closest('blockquote');
                                
                                if (blockquote) {
                                    // 已经在blockquote内，取消引用格式
                                    // 将blockquote内的内容移出
                                    const content = blockquote.innerHTML;
                                    const div = document.createElement('div');
                                    div.innerHTML = content;
                                    
                                    // 用div的内容替换blockquote
                                    blockquote.parentNode.replaceChild(div, blockquote);
                                    
                                    // 合并相邻的段落
                                    const paragraphs = div.querySelectorAll('p');
                                    paragraphs.forEach(p => {
                                        if (p.innerHTML === '<br>') {
                                            p.remove();
                                        }
                                    });
                                } else {
                                    // 不在blockquote内，添加引用格式
                                    document.execCommand(command, false, value);
                                }
                            }
                        } else if (value) {
                            document.execCommand(command, false, value);
                        } else {
                            document.execCommand(command, false, null);
                        }
                    });
                });
                
                // 字体大小选择器 - 修复版本
                document.getElementById('font-size-select').addEventListener('change', (e) => {
                    const sizeClass = e.target.value;
                    if (sizeClass) {
                        const editor = document.getElementById('editor');
                        editor.focus();
                        
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            
                            // 获取选中的内容
                            const selectedText = selection.toString();
                            
                            if (selectedText.length > 0) {
                                // 如果有选中的文本，直接应用样式
                                const span = document.createElement('span');
                                span.className = sizeClass;
                                
                                // 保存当前选区
                                const clonedRange = range.cloneRange();
                                const fragment = clonedRange.extractContents();
                                
                                span.appendChild(fragment);
                                clonedRange.insertNode(span);
                                
                                // 恢复选区到新插入的span
                                const newRange = document.createRange();
                                newRange.selectNodeContents(span);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            } else {
                                // 没有选中文本，在插入点添加样式
                                const span = document.createElement('span');
                                span.className = sizeClass;
                                span.innerHTML = '&nbsp;'; // 插入一个空格
                                
                                range.deleteContents();
                                range.insertNode(span);
                                
                                // 将光标移动到span内部
                                const newRange = document.createRange();
                                newRange.setStart(span, 0);
                                newRange.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                            
                            // 重置选择器
                            e.target.value = '';
                        }
                    }
                });
                
                // 字体颜色选择器
                document.getElementById('font-color').addEventListener('input', (e) => {
                    document.getElementById('editor').focus();
                    document.execCommand('foreColor', false, e.target.value);
                });
                
                // 背景颜色选择器
                document.getElementById('bg-color').addEventListener('input', (e) => {
                    document.getElementById('editor').focus();
                    document.execCommand('backColor', false, e.target.value);
                });
                
                // 插入代码块 - 修复版本（不会超出宽度）
                document.getElementById('insert-code').addEventListener('click', () => {
                    const editor = document.getElementById('editor');
                    editor.focus();
                    
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        
                        // 获取选中的文本
                        const selectedText = selection.toString();
                        
                        // 创建pre元素
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        code.textContent = selectedText || '// 在这里输入代码';
                        pre.appendChild(code);
                        
                        range.deleteContents();
                        range.insertNode(pre);
                        
                        // 将光标移动到代码块内部
                        const newRange = document.createRange();
                        newRange.setStart(code, 0);
                        newRange.setEnd(code, code.textContent.length);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                });
                
                // 插入水平线
                document.getElementById('insert-hr').addEventListener('click', () => {
                    const editor = document.getElementById('editor');
                    editor.focus();
                    
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        
                        // 保存当前选区位置
                        const container = range.commonAncestorContainer;
                        const offset = range.startOffset;
                        
                        // 创建水平线
                        const hr = document.createElement('hr');
                        
                        // 创建占位符段落（在水平线后）
                        const placeholderAfter = document.createElement('p');
                        placeholderAfter.innerHTML = '<br>';
                        placeholderAfter.style.marginTop = '10px';
                        
                        // 创建占位符段落（在水平线前）
                        const placeholderBefore = document.createElement('p');
                        placeholderBefore.innerHTML = '<br>';
                        placeholderBefore.style.marginBottom = '10px';
                        
                        // 获取当前容器节点
                        if (container.nodeType === Node.TEXT_NODE) {
                            const parent = container.parentNode;
                            
                            // 分割文本节点
                            const beforeText = container.textContent.substring(0, offset);
                            const afterText = container.textContent.substring(offset);
                            
                            // 创建文本节点
                            const beforeNode = document.createTextNode(beforeText);
                            const afterNode = document.createTextNode(afterText);
                            
                            // 清空父节点内容
                            while (parent.firstChild) {
                                parent.removeChild(parent.firstChild);
                            }
                            
                            // 重新构建结构
                            if (beforeText.trim()) {
                                const beforePara = document.createElement('p');
                                beforePara.appendChild(beforeNode);
                                parent.appendChild(beforePara);
                            }
                            
                            parent.appendChild(placeholderBefore);
                            parent.appendChild(hr);
                            parent.appendChild(placeholderAfter);
                            
                            if (afterText.trim()) {
                                const afterPara = document.createElement('p');
                                afterPara.appendChild(afterNode);
                                parent.appendChild(afterPara);
                            }
                            
                            // 将光标移动到水平线后的占位符
                            const newRange = document.createRange();
                            newRange.setStart(placeholderAfter, 0);
                            newRange.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                        } else {
                            // 直接插入水平线和占位符
                            range.deleteContents();
                            range.insertNode(placeholderBefore);
                            range.insertNode(hr);
                            range.insertNode(placeholderAfter);
                            
                            // 将光标移动到水平线后的占位符
                            const newRange = document.createRange();
                            newRange.setStart(placeholderAfter, 0);
                            newRange.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                        }
                        
                        // 防止水平线被误删除
                        hr.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                    }
                });
                
                // Tab键缩进功能
                document.getElementById('editor').addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        
                        const editor = document.getElementById('editor');
                        const selection = window.getSelection();
                        
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            const span = document.createElement('span');
                            span.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;'; // 4个空格
                            span.style.whiteSpace = 'pre';
                            
                            range.insertNode(span);
                            
                            // 将光标移动到插入的内容之后
                            range.setStartAfter(span);
                            range.setEndAfter(span);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                    }
                    
                    // 处理blockquote内的回车
                    if (e.key === 'Enter') {
                        this.handleQuoteEnter(e);
                    }
                });
                
                // 关闭导出模态框
                document.getElementById('close-export-modal').addEventListener('click', () => {
                    document.getElementById('export-modal').classList.add('hidden');
                });
                
                // 点击模态框外部关闭
                document.getElementById('export-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('export-modal')) {
                        document.getElementById('export-modal').classList.add('hidden');
                    }
                });
                
                // 复制导出内容
                document.getElementById('copy-export-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(this.currentExportContent).then(() => {
                        this.showMessage('内容已复制到剪贴板', 'success');
                    }).catch(err => {
                        console.error('复制失败: ', err);
                        this.showMessage('复制失败，请手动复制', 'error');
                    });
                });
                
                // 下载导出文件
                document.getElementById('download-export-btn').addEventListener('click', () => {
                    const blob = new Blob([this.currentExportContent], { 
                        type: this.currentExportType === 'html' ? 'text/html' : 'text/markdown' 
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.currentExportFileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage(`文件已下载: ${this.currentExportFileName}`, 'success');
                    document.getElementById('export-modal').classList.add('hidden');
                });
                
                // 编辑器焦点处理
                const editor = document.getElementById('editor');
                editor.addEventListener('focus', () => {
                    if (editor.innerHTML === '<p>说点什么吧，不然好寂寞</p>') {
                        editor.innerHTML = '';
                    }
                });
                
                editor.addEventListener('blur', () => {
                    if (!editor.innerHTML.trim() || editor.innerHTML === '<br>') {
                        editor.innerHTML = '<p>说点什么吧，不然好寂寞</p>';
                    }
                });
                
                // 初始化时绑定handleQuoteEnter的上下文
                this.handleQuoteEnter = this.handleQuoteEnter.bind(this);
            }
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            // 确保页面加载时模态框是隐藏的
            document.getElementById('export-modal').classList.add('hidden');
            
            // 初始化页面切换功能
            new PageSwitcher();
            
            // 初始化文章管理器
            new ArticleManager();
        });
    </script>
</body>
</html>